#!/bin/bash

mydir=`dirname $0`
cd "$mydir"
mydir=`pwd -P`

checkonly=false
finishonly=false
metonly=false

while [ $# -gt 0 ]; do
    case "$1" in
        --check-only)
        checkonly=true
        ;;
        --finish-only)
        finishonly=true
        ;;
        --met-only)
        metonly=true
        pcargs="--met-only"
        ;;
    esac
    shift
done

# Do a quick check of the most important namelist options
# before starting the prep
PREPINPUT/precheck $pcargs
chkexit=$?
if [ $chkexit -ne 0 ]; then
    exit $chkexit
fi

if $checkonly; then
    exit 0
fi

if $finishonly; then
    cd ../WRFV3/run
    pwd
    ls met_em* >& /dev/null
    if [ $? -eq 0 ]; then
        # Met files linked in WRFV3/run, no need to redo
        dowps=false
    else
        dowps=true
    fi

    if [ -f wrfem_00to12Z -a -f wrfem_12to24Z ]; then
        doemiss=false
    else
        doemiss=true
    fi

    if [ -f wrfchemi_00z_d01 -a -f wrfchemi_12z_d01 ]; then
        doconv=false
    else
        doconv=true
    fi

    if [ -f wrfbiochemi_d01 ]; then
        domegan=false
    else
        domegan=true
    fi
    cd "$mydir"
else
    dowps=true
    doemiss=true
    doconv=true
    domegan=true
fi


# Ensure that namelist.input is linked
# Backup only if not already a link to somewhere
cd ../WRFV3/run
if [ -f namelist.input ]; then
    lnk=`readlink namelist.input`
    if [ ! -z $lnk ]; then
        mv namelist.input namelist.input.autowrf-backup
    fi
fi
ln -sf "$mydir/CONFIG/namelist.input"
cd "$mydir"

# The exit status needs to be 0 if everything works,
# otherwise have bits representing which one failed
# start as 011111 and remove 1's as things succeed
# = 2+4+8+16+32 = 62
if $metonly; then
    exitstat=3
else
    exitstat=62
fi

if $dowps; then
    echo "Running WPS..."
    PREPINPUT/prepwps
    wpsexit=$?
    if [ $wpsexit -eq 0 ]; then
        exitstat=$((exitstat-2))
    fi
else
    echo "Met files detected, skipping WPS."
    exitstat=$((exitstat-2))
fi

if $metonly; then
    if [ $wpsexit -eq 0 ]; then
        echo "Running real.exe since only the meterology has been requested."
        cd ../WRFV3/run
        ./real.exe
        realexit=$?
        if [ $realexit -eq 0 ]; then
            exitstat=$((exitstat-1))
        fi
    else
        echo "WPS failed, not running real.exe."
    fi
    exit $exitstat
fi

if $doemiss; then
    echo "Running emiss_v04..."
    PREPINPUT/prepnei_intermediate
    neiexit=$?
    if [ $neiexit -eq 0 ]; then
        exitstat=$((exitstat-4))
    fi
else
    echo "wrfem files found, skipping emiss_v04"
    exitstat=$((exitstat-4))
fi


if $doconv; then
    echo "Running convert_emiss.exe"
    PREPINPUT/prepnei_convert
    convexit=$?
    if [ $convexit -eq 0 ]; then
        exitstat=$((exitstat-8))
    fi
else
    echo "wrfchemi files detected, skipping convert_emiss.exe"
    exitstat=$((exitstat-8))
fi
    
if $domegan; then
    echo "Running MEGAN"
    PREPINPUT/prepmegan
    meganexit=$?
    if [ $meganexit -eq 0 ]; then
        exitstat=$((exitstat-16))
    fi
else
    echo "wrfbiochemi file found, skipping MEGAN"
    exitstat=$((exitstat-16))
fi
    
echo "Running MOZBC..."
PREPINPUT/prepmozbc
mozbcexit=$?
if [ $mozbcexit -eq 0 ]; then
    exitstat=$((exitstat-32))
fi


exit $exitstat
